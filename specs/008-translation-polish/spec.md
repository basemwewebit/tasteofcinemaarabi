# Feature Specification: Translation Polish & Content Cleanup

**Feature Branch**: `008-translation-polish`  
**Created**: 2026-03-01  
**Status**: Draft  
**Input**: User description: "بدنا نزبط سلوك الترجمة - إصلاح الرموز غير المرغوبة وإعادة صياغة المحتوى بعد الترجمة مع الأولوية للمحتوى المسحوب مسبقاً"

---

## Clarifications

### Session 2026-03-01

- Q: ما هو مستوى التدخل المسموح به لمرحلة إعادة الصياغة؟ → A: إعادة صياغة الأسلوب فقط — الـ AI يُحسّن الجمل والتدفق دون تغيير ترتيب الفقرات أو حذف أي معلومات.
- Q: كيف يتعامل النظام مع المقالات التي تتجاوز حدود معالجة الـ AI؟ → A: تقسيم فقراتي — يُقسَّم المقال على أساس الفقرات إلى أجزاء بحجم مناسب، يُعالَج كل جزء منفصلاً ثم تُدمَج النتائج في نص واحد.
- Q: ماذا يفعل النظام عند اكتشاف أن النسخة المحلية للمقال تالفة أو ناقصة؟ → A: إعادة سحب تلقائي — يكتشف النظام الفساد، يسحب النسخة الأصلية من الويبسايت، يُحدّث المخزن المحلي، ويكمل المعالجة دون تدخل يدوي.
- Q: هل مرحلة إعادة الصياغة إلزامية أم اختيارية؟ → A: اختيارية مفعّلة افتراضياً — تعمل في كل عملية ما لم يختر المستخدم تعطيلها صراحةً عبر إعداد أو خيار (flag) مخصص.
- Q: كيف يُحدَّد النظام الكلمات والمصطلحات التي يجب ألا تُعدَّل أثناء إعادة الصياغة؟ → A: قائمة محمية + كشف سياق تلقائي — قائمة ثابتة للمصطلحات الخاصة بالموقع، مع تعليمات للـ AI لعدم تعديل أسماء الأفلام والأسماء الشخصية تلقائياً بالاعتماد على السياق.

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - إزالة الرموز غير المرغوبة من المحتوى المترجم (Priority: P1)

عندما يُترجم محتوى مقال سينمائي، يظهر أحياناً رموز غريبة وعلامات غير مرئية (مثل `\u200b`، أو `\u00a0`، أو رموز Unicode غير مرتبطة بالنص العربي) تُشوّه مظهر النص النهائي.

**Why this priority**: هذا يؤثر مباشرةً على جودة المحتوى المنشور ويعطي انطباعاً سلبياً للقارئ. إصلاحه فوري وأساسي.

**Independent Test**: يمكن تشغيل سكريبت الترجمة على مقال واحد والتحقق أن النص الناتج لا يحتوي على أي رموز Unicode غير مرئية أو علامات ترقيم مزدوجة أو محارف بديلة.

**Acceptance Scenarios**:

1. **Given** محتوى مترجم يحتوي على `\u200b` أو `\u00a0` أو `﻿`, **When** يمر على مرحلة التنظيف, **Then** يُزال كل رمز غير مرئي من النص النهائي.
2. **Given** محتوى به علامات اقتباس انجليزية (`"` `"`) أو شرطات طويلة (`—`), **When** يمر على مرحلة التنظيف, **Then** تُحوَّل إلى مكافئاتها العربية الصحيحة أو تُزال حسب السياق.
3. **Given** محتوى يحمل مسافات متعددة متتالية أو أسطر فارغة زائدة, **When** يمر التنظيف, **Then** تُوحَّد المسافات وتُنظَّف الأسطر.

---

### User Story 2 - إعادة الصياغة الأنيقة بعد الترجمة (Priority: P2)

بعد ترجمة المقال، قد يظهر المحتوى كأنه "نسخ ولصق" مباشر دون اعتبار للسياق العربي؛ الجمل تبدو مقطوعة، وترتيب الأفكار لا يناسب أسلوب الكتابة العربية السينمائية.

**Why this priority**: المقروئية والأناقة اللغوية هما ركيزتا موقع ذوق السينما. المحتوى يجب أن يبدو مكتوباً بالعربية أصلاً لا مترجماً.

**Independent Test**: مقارنة نص قبل وبعد مرحلة إعادة الصياغة تُظهر: جمل أكثر تدفقاً، وانتقالات أفضل بين الفقرات، وحذف العبارات الحرفية الغريبة على القارئ العربي.

**Acceptance Scenarios**:

1. **Given** جملة مترجمة حرفياً تبدو مقطوعة من السياق, **When** تمر على مرحلة إعادة الصياغة, **Then** تُعاد صياغتها بلغة عربية سلسة مع الحفاظ على المعنى الأصلي.
2. **Given** فقرة تبدأ بكلمات ترابط انجليزية مترجمة حرفياً مثل "ومع ذلك" في غير موضعها, **When** تمر مرحلة الصياغة, **Then** تُعدَّل أو تُحذف لتناسب السياق.
3. **Given** محتوى مترجم ناجح, **When** تنتهي مرحلة إعادة الصياغة, **Then** لا يتغير المعنى الجوهري للمقال بل يتحسن فقط الأسلوب.

---

### User Story 3 - أولوية المحتوى المسحوب مسبقاً (Priority: P3)

عندما يطلب المستخدم معالجة مقال ما، يجب أن يتحقق النظام أولاً من وجود نسخة مسحوبة (scraped) محلياً قبل الاتجاه إلى سحبها من الويبسايت من جديد.

**Why this priority**: يحافظ على الوقت والموارد، ويضمن عدم تكرار السحب غير الضروري.

**Independent Test**: تشغيل عملية معالجة مقال موجود أصلاً في المجلد المحلي للمسحوبات يُعيد النتيجة باستخدام المحتوى المحلي فقط، دون اتصال بالإنترنت.

**Acceptance Scenarios**:

1. **Given** مقال موجود في مجلد السحب المحلي, **When** يبدأ المستخدم عملية الترجمة, **Then** يستخدم النظام النسخة المحلية مباشرةً دون سحب جديد.
2. **Given** مقال غير موجود محلياً, **When** يبدأ المستخدم عملية الترجمة, **Then** يسحب النظام المقال من الويبسايت الأصلي تلقائياً ثم يحفظه محلياً.
3. **Given** نسخة محلية قديمة موجودة, **When** يريد المستخدم تحديث المحتوى, **Then** يوجد خيار لإجبار السحب الجديد من المصدر.

---

### Edge Cases

- ماذا يحدث إذا كان المحتوى المسحوب بالفعل غير مكتمل أو تالفاً؟ يكتشف النظام الفساد تلقائياً، يسحب نسخة جديدة من المصدر، يُحدّث المخزن المحلي، ثم يكمل المعالجة دون تدخل يدوي.
- كيف يتعامل النظام مع المقالات التي تحتوي على كلمات تقنية أو أسماء أفلام يجب ألا تُترجم؟
- ماذا لو فشلت مرحلة إعادة الصياغة بسبب خطأ في الـ AI؟ هل يُنقذ الإصدار المترجم الأساسي؟
- للمقالات التي تتجاوز حدود معالجة الـ AI: يُقسَّم المقال إلى أجزاء على حدود الفقرات، تُعالَج منفصلةً وتُدمَج لاحقاً — مع ضمان الاتساق الأسلوبي بين الأجزاء.

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: النظام يجب أن يُزيل تلقائياً كل الرموز Unicode غير المرئية والمحارف البديلة من المحتوى المترجم قبل الحفظ النهائي.
- **FR-002**: النظام يجب أن يُوحِّد علامات الترقيم (اقتباسات، شرطات، مسافات) لتتوافق مع معايير الكتابة العربية.
- **FR-003**: يجب أن تتم مرحلة إعادة الصياغة الأنيقة **بعد** اكتمال الترجمة النهائية وليس قبلها أو أثناءها. تقتصر هذه المرحلة على تحسين الأسلوب والتدفق اللغوي فقط، دون تغيير ترتيب الفقرات أو حذف أي معلومات أو إضافة محتوى جديد.
- **FR-004**: النظام يجب أن يتحقق من وجود المحتوى في المخزن المحلي أولاً قبل بدء أي طلب سحب من الإنترنت.
- **FR-005**: في حالة غياب المحتوى محلياً، يجب على النظام سحبه تلقائياً وتخزينه محلياً للاستخدامات المستقبلية.
- **FR-006**: مرحلة إعادة الصياغة يجب ألا تُعدِّل أسماء الأفلام والمصطلحات السينمائية المتعارف عليها. يعتمد ذلك على آليتين مدمجتين: (1) قائمة ثابتة قابلة للتحديث من المصطلحات الخاصة بالموقع، و(2) تعليمات سياق للـ AI تمنعه من تعديل الأسماء الأجنبية للأفلام والأشخاص التي يكتشفها من سياق النص.
- **FR-007**: على النظام الحفاظ على نسخة احتياطية من المحتوى المترجم قبل تطبيق مرحلة إعادة الصياغة.
- **FR-008**: في حالة فشل مرحلة إعادة الصياغة، يجب أن يسقط النظام إلى النسخة المترجمة الأساسية ويُبلّغ المستخدم.
- **FR-009**: للمقالات التي تتجاوز حجم المعالجة الواحدة، يجب أن يُقسِّم النظام المحتوى تلقائياً على حدود الفقرات، يُعالج كل جزء باستقلالية، ثم يدمجها في نص نهائي واحد مترابط.
- **FR-010**: عند اكتشاف أن النسخة المحلية تالفة أو ناقصة، يجب أن يتحقق النظام تلقائياً، يسحب المحتوى مجدداً من المصدر الأصلي، يُحدّث النسخة المحلية، ثم يكمل المعالجة دون تدخل من المستخدم.
- **FR-011**: مرحلة إعادة الصياغة تكون مفعّلة افتراضياً في كل عملية ترجمة. يجب أن يتمكن المستخدم من تعطيلها صراحةً عبر إعداد أو خيار مخصص، لتطبيق مرحلة التنظيف (FR-001, FR-002) فقط دون إعادة الصياغة.

### Key Entities

- **ScrapedContent**: المحتوى المسحوب من المصدر الأصلي - يشمل النص الانجليزي، الصور، والبيانات الوصفية. يُخزَّن محلياً بعد أول سحب.
- **TranslatedContent**: المحتوى بعد الترجمة الآلية - نص عربي خام قد يحتوي على رموز أو أسلوب يحتاج تحسيناً.
- **PolishedContent**: المحتوى النهائي بعد التنظيف وإعادة الصياغة - جاهز للنشر بشكل أنيق.
- **TranslationPipeline**: تسلسل المراحل: سحب → ترجمة → تنظيف رموز → إعادة صياغة → حفظ.
- **ProtectedTermsList**: قائمة ثابتة قابلة للتحديث تحتوي على المصطلحات السينمائية الخاصة بالموقع وأسماء الأفلام التي يجب على الـ AI الحفاظ عليها دون تعديل أثناء مرحلة إعادة الصياغة.

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: لا يحتوي أي مقال منشور على رموز Unicode غير مرئية أو محارف بديلة - معدل صفر أخطاء بعد المعالجة.
- **SC-002**: يُدرك القارئ العربي المقال على أنه مكتوب بالعربية بشكل طبيعي، لا مترجماً - مقياس ذاتي يُقاس بمراجعة عينة من 10 مقالات.
- **SC-003**: وقت معالجة المقالات الموجودة محلياً أقل بـ 50% مقارنةً بإعادة سحبها من الإنترنت.
- **SC-004**: في حال فشل مرحلة إعادة الصياغة، يصل المستخدم للمحتوى المترجم الأساسي خلال أقل من 5 ثواني دون فقدان أي بيانات.
- **SC-005**: 100% من المقالات المعالجة تحتفظ بالمعنى الجوهري للنص الأصلي عند المراجعة اليدوية.

---

## Assumptions

- مسار تخزين المحتوى المسحوب محلياً محدد مسبقاً في إعدادات النظام.
- الـ AI المستخدم في مرحلة إعادة الصياغة هو نفس النموذج في pipeline الترجمة الحالي (OpenRouter).
- لا توجد قيود قانونية تمنع سحب وتخزين المحتوى من المصادر المعتمدة.
- أسماء الأفلام والمصطلحات الأجنبية تُترك كما هي في الغالب وفق أسلوب الموقع الحالي.
